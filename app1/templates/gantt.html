<html>
    <head>
        {% load static %}
        <script src="{% static "plugins/codebase/dhtmlxgantt.js" %}" type="text/javascript">
        </script>
        <link rel="stylesheet" href="{% static "plugins/codebase/dhtmlxgantt.css" %}" />
    </head>
    <body>
        <div id="gantt_here" style='width:100%; height:500px;'>
        </div>
        <script>
{#Customize the Gantt chart position column here#}
        gantt.config.columns =  [
    {name:"text",       label:"Task name",  tree:true, width:"*" },
    {name:"Holder",     label:"Holder",     align:"center" },
    {name:"start_date", label:"Start time", align:"center" },
    {name:"end_date",   label:"End date",   align:"center" },
    {name:"progress",   label:"Progress",   align:"center" },
    {name: "add", width: 44 }
];

{#Customize the Gantt chart lightbox here, adding the holder and progress properties#}
    gantt.config.lightbox.sections=[
    {name:"description", height:70, map_to:"text", type:"textarea", focus:true},
    {name:"holder", height:30, map_to:"Holder", type:"textarea"},
    {name:"progress", height:30, map_to:"progress", type: "progress"},
    {name:"time", height:72, map_to:"auto", type:"duration"}
];

{#Make user-friendly progress input easier by creating a function to customize the range scrollbar#}
    gantt.templates.progress_text = function(start, end, task) {
        return "<div class='gantt_task_progress_text'>" + Math.round(task.progress * 100) + "%</div>";
    };


    var range = "<div class='dhx_cal_ltext' style='height:30px;'><input type='range' min='0' max='100' value='0' step='1' style='width:100%;' oninput='outputUpdate(value)'></div>" +
    "<span id='output'>0%</span>"

    function outputUpdate(value) {document.getElementById('output').innerText = value + '%';};

    gantt.form_blocks["progress"] = {

            render: function(sns) {
                return range
            },
            set_value: function(node, value, task) {
                node.getElementsByTagName("input")[0].value = value * 100;
            },
            get_value: function(node, task) {
                return node.getElementsByTagName("input")[0].value / 100;
            },
            focus: function(node) {
                var a = node.getElementsByTagName("input")[0];
                a.focus();
                a.select();
            }
        };

        gantt.attachEvent("onLightboxSave", function(id, task, is_new) {
            var progress = task.progress;
            gantt.getTask(id).progress = progress;
            gantt.updateTask(id);
            return true;
        });

{#Name the new properties in the lightbox#}
    gantt.locale.labels.section_holder = "Holder";
    gantt.locale.labels.section_progress = "Progress";

    gantt.config.scales = [
    {unit: "month", step: 1, format: "%F, %Y"},
    {unit: "day", step:1, format: "%j, %D"}
];

    gantt.attachEvent("onTaskUpdated", function(id, task){
    // 获取当前时间
    var currentDate = new Date();

    // 获取已经更新的任务
    var task1 = gantt.getTask(id);

    // 判断当前时间是否超过任务结束时间
    if(currentDate > gantt.calculateEndDate(task1)){
        // 判断进度是否未达到100%
        if(task1.progress < 1){
            // 未达到100%则改变任务颜色
            task1.color = "red"; // 这里可以设置为你想要的颜色
            gantt.refreshData(); // 刷新数据以应用新的颜色
        }
    }
});

{#The adaptive display of Gantt chart is realized by these two functions#}
    gantt.attachEvent("onBeforeGanttRender", function(){
    var range = gantt.getSubtaskDates();
    var scaleUnit = gantt.getState().scale_unit;
    if(range.start_date && range.end_date){
     gantt.config.start_date = gantt.calculateEndDate(range.start_date, -4, scaleUnit);
     gantt.config.end_date = gantt.calculateEndDate(range.end_date, 5, scaleUnit);
   }
});

    gantt.attachEvent("onTaskDrag", function(id, mode, task, original){
        var state = gantt.getState();
        var minDate = state.min_date,
        maxDate = state.max_date;

    var scaleStep=gantt.date.add(new Date(),state.scale_step,state.scale_unit)-new Date();

    var showDate,
    repaint = false;
    if(mode == "resize" || mode == "move"){
        if(Math.abs(task.start_date - minDate) < scaleStep){
        showDate = task.start_date;
        repaint = true;

    }else if(Math.abs(task.end_date - maxDate) < scaleStep){
        showDate = task.end_date;
        repaint = true;
    }

    if(repaint){
        gantt.render();
        gantt.showDate(showDate);
    }
  }
});
gantt.config.show_tasks_outside_timescale = true;


    gantt.config.date_format = "%d-%m-%Y %H:%i";

    gantt.config.open_tree_initially = true;
    gantt.init("gantt_here");
    gantt.load("/getGanttData/")

    var dp = gantt.createDataProcessor({
        url: "/changeGanttData/",
        mode: "GET",
        deleteAfterConfirmation: true
    });
</script>
</body>
</html>