{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="{% static 'plugins/bootstrap-3.4.1-dist/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/index.css' %}">


    <link rel="stylesheet" href="{% static "plugins/codebase/dhtmlxgantt.css" %}"/>
    <style>
        .gantt_task_line {
            border-color: rgba(0, 0, 0, 0.25);
        }

        .gantt_task_line .gantt_task_progress {
            background-color: rgba(0, 0, 0, 0.25);
        }

        .important {
        {#color: #ff5956;#} background-color: #ff5956; /* Change to red */
        }

        .important .gantt_task_progress {
            background-color: red;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-default">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse"
                    aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#">SDAI</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="navbar-collapse">
            <ul class="nav navbar-nav navbar-right">
                <li><a href="#">HOME</a></li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
                       aria-expanded="false">Register/Login<span class="caret"></span></a>
                    <ul class="dropdown-menu">
                        <li><a href="/register/">Register</a></li>
                        <li role="separator" class="divider"></li>
                        <li><a href="/login/">Login</a></li>
                    </ul>
                </li>
            </ul>
        </div><!-- /.navbar-collapse -->
    </div><!-- /.container-fluid -->
</nav>



<div id="gantt_here" style='width:100%; height:500px;'>
</div>
{#{% csrf_token %}#}

<script src="{% static "plugins/codebase/dhtmlxgantt.js" %}" type="text/javascript">
    </script>
    <script src="{% static "plugins/js.cookie.min.js" %}" type="text/javascript"></script>
<script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
<script src="{% static 'plugins/bootstrap-3.4.1-dist/js/bootstrap.min.js' %}"></script>
<script>

    const csrftoken = Cookies.get('csrftoken');

    var opts;


    async function fetchData() {
        try {
            const response = await fetch('/getMemberData/');
            const data = await response.json();
            opts = data;

            initGanttChat();
        } catch (error) {
            console.error('Fetch error:', error);
            throw error;
        }
    }


    gantt.plugins({
        marker: true
    });

    function initGanttChat() {
        gantt.init("gantt_here");
        gantt.load("/getGanttData/");

        {#Customize the Gantt chart position column here#}
        gantt.config.columns = [
            {name: "text", label: "Task name", tree: true, width: "*"},
            {name: "Holder", label: "Holder", align: "center"},
            {name: "start_date", label: "Start time", align: "center"},
            {name: "end_date", label: "End date", align: "center"},
            {name: "progress", label: "Progress", align: "center"},
            {name: "add", width: 44}
        ];

        {#Customize the Gantt chart lightbox here, adding the Holder and progress properties#}
        gantt.config.lightbox.sections = [
            {name: "description", height: 70, map_to: "text", type: "textarea", focus: true},
            {name: "Holder", height: 30, map_to: "Holder", type: "select", options: opts},
            {name: "progress", height: 30, map_to: "progress", type: "progress"},
            {name: "time", height: 72, map_to: "auto", type: "duration"}
        ];
    }



    var dp = gantt.createDataProcessor({
        url: "/changeGanttData/",
        mode: "POST",
        deleteAfterConfirmation: true,
    });

    dp.attachEvent("onBeforeUpdate", function (id, state, data) {
        data.csrfmiddlewaretoken = csrftoken;
        return true;
    });


    {#Make user-friendly progress input easier by creating a function to customize the range scrollbar#}
    gantt.templates.progress_text = function (start, end, task) {
        {#return "<div class='gantt_task_progress_text'>" + Math.round(task.progress * 100) + "%</div>";#}
        return "";
    };


    var range = "<div class='dhx_cal_ltext' style='height:30px;'><input type='range' min='0' max='100' value='0' step='1' style='width:100%;' oninput='outputUpdate(value)'></div>" +
        "<span id='output'>0%</span>"

    function outputUpdate(value) {
        document.getElementById('output').innerText = value + '%';
    };

    gantt.form_blocks["progress"] = {

        render: function (sns) {
            return range
        },
        set_value: function (node, value, task) {
            node.getElementsByTagName("input")[0].value = value * 100;
        },
        get_value: function (node, task) {
            return node.getElementsByTagName("input")[0].value / 100;
        },
        focus: function (node) {
            var a = node.getElementsByTagName("input")[0];
            a.focus();
            a.select();
        }
    };

    gantt.attachEvent("onLightboxSave", function (id, task, is_new) {
        var progress = task.progress;
        gantt.getTask(id).progress = progress;
        gantt.updateTask(id);
        return true;
    });

    {#Name the new properties in the lightbox#}
    gantt.locale.labels.section_Holder = "Holder";
    gantt.locale.labels.section_progress = "Progress";

    gantt.config.scales = [
        {unit: "month", step: 1, format: "%F, %Y"},
        {unit: "day", step: 1, format: "%j, %D"}
    ];


    {#The adaptive display of Gantt chart is realized by these two functions#}
    gantt.attachEvent("onBeforeGanttRender", function () {
        var range = gantt.getSubtaskDates();
        var scaleUnit = gantt.getState().scale_unit;
        if (range.start_date && range.end_date) {
            gantt.config.start_date = gantt.calculateEndDate(range.start_date, -4, scaleUnit);
            gantt.config.end_date = gantt.calculateEndDate(range.end_date, 5, scaleUnit);
        }
    });

    gantt.attachEvent("onTaskDrag", function (id, mode, task, original) {
        var state = gantt.getState();
        var minDate = state.min_date,
            maxDate = state.max_date;

        var scaleStep = gantt.date.add(new Date(), state.scale_step, state.scale_unit) - new Date();

        var showDate,
            repaint = false;
        if (mode == "resize" || mode == "move") {
            if (Math.abs(task.start_date - minDate) < scaleStep) {
                showDate = task.start_date;
                repaint = true;

            } else if (Math.abs(task.end_date - maxDate) < scaleStep) {
                showDate = task.end_date;
                repaint = true;
            }

            if (repaint) {
                gantt.render();
                gantt.showDate(showDate);
            }
        }
    });
    gantt.config.show_tasks_outside_timescale = true;


    gantt.config.date_format = "%d-%m-%Y %H:%i";

    gantt.config.open_tree_initially = true;


    var dateToStr = gantt.date.date_to_str(gantt.config.task_date);
    var markerId = gantt.addMarker({
        start_date: new Date(), //a Date object that sets the marker's date
        css: "today", //a CSS class applied to the marker
        text: "Now", //the marker title
        title: dateToStr(new Date()) // the marker's tooltip
    });
    gantt.getMarker(markerId);


    gantt.templates.task_class = function (start, end, task) {
        if (task.progress < 1 && new Date(task.end_date) <= new Date()) {
            return "important";
        } else {
            return "";
        }
    };

    fetchData();


</script>
</body>
</html>